# 三层规划控制架构

## 架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                        目标点 (Goal)                         │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  Layer 1: 全局路径规划 (A*)                                  │
│  ─────────────────────────                                  │
│  输入: 起点、终点、栅格地图                                   │
│  输出: 几何路径 [(x,y), ...]                                 │
│  话题: /global_path (绿色)                                   │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  Layer 2: 轨迹生成 (B样条 + 速度规划)                         │
│  ─────────────────────────────────                          │
│  输入: 几何路径、当前状态                                     │
│  输出: 时间参数化轨迹 [{x,y,θ,v,ω,t}, ...]                   │
│  话题: /reference_trajectory (蓝色)                          │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  Layer 3: 轨迹跟踪 (非线性MPC)                               │
│  ──────────────────────────                                 │
│  输入: 当前状态、参考轨迹窗口                                 │
│  输出: 控制量 [v, ω]                                         │
│  话题: /mpc_predict_path (红色)                              │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    /cmd_vel → 机器人                         │
└─────────────────────────────────────────────────────────────┘
```

---

## Layer 1: 全局路径规划 (A*)

**算法**: A* 搜索算法

**优化目标**: 最短路径（欧氏距离启发式）

$$f(n) = g(n) + h(n)$$

- $g(n)$: 起点到当前节点的实际代价
- $h(n)$: 当前节点到终点的启发式估计（欧氏距离）

**特点**:
- 栅格地图上搜索
- 障碍物膨胀（inflate_radius=0.25m）
- 输出离散路径点

---

## Layer 2: 轨迹生成 (B样条 + 速度规划)

**算法**: 
1. **B样条平滑**: 将离散路径平滑为连续曲线
2. **速度规划**: 基于曲率和加速度约束的梯形速度曲线

**优化目标**: 满足动力学约束的平滑轨迹

**速度约束**:
$$v \leq \frac{v_{max}}{\sqrt{1 + k|\kappa|}}$$

**加速度约束** (前向-后向传播):
$$v_{i+1}^2 \leq v_i^2 + 2 a_{max} \cdot \Delta s$$

**输出**: 时间参数化轨迹 `{x, y, θ, v, ω, t}`

---

## Layer 3: 轨迹跟踪 (非线性MPC)

**算法**: 非线性模型预测控制 (CasADi + IPOPT)

**优化目标**:

$$\min_{u} \sum_{k=0}^{N-1} \left[ (x_k - x_{ref})^T Q (x_k - x_{ref}) + u_k^T R \, u_k \right] + (x_N - x_{ref})^T Q_f (x_N - x_{ref})$$

**动力学模型** (差速驱动):
$$\begin{cases}
\dot{x} = v \cos\theta \\
\dot{y} = v \sin\theta \\
\dot{\theta} = \omega
\end{cases}$$

**约束**:
- 速度: $v \in [-0.05, 0.22]$ m/s
- 角速度: $\omega \in [-2.0, 2.0]$ rad/s

---

## ROS 话题

| 话题 | 类型 | 描述 | 可视化颜色 |
|------|------|------|-----------|
| `/global_path` | Path | A* 全局路径 | 绿色 |
| `/reference_trajectory` | Path | B样条平滑轨迹 | 蓝色 |
| `/mpc_predict_path` | Path | MPC 预测轨迹 | 红色 |
| `/cmd_vel` | Twist | 控制指令 | - |

---

## 参数配置

```yaml
# Layer 1
resolution: 0.05        # 栅格分辨率 (m)
inflate_radius: 0.25    # 障碍物膨胀半径 (m)

# Layer 2
v_max: 0.18            # 最大线速度 (m/s)
v_min: 0.08            # 最小线速度 (m/s)
w_max: 1.2             # 最大角速度 (rad/s)
a_max: 0.5             # 最大加速度 (m/s²)

# Layer 3
dt: 0.1                # 控制周期 (s)
N: 20                  # 预测步数
replan_interval: 3.0   # 重规划间隔 (s)
```

---

## 文件结构

```
scripts/
├── mpc_three_layer.py   # 主控制器（整合三层）
├── global_planner.py    # Layer 1: A* 全局规划
├── local_planner.py     # Layer 2: B样条 + 速度规划
└── mpc_tracker.py       # Layer 3: 非线性MPC
```
