<launch>
  <!-- ========================================================= -->
  <!--  统一 MPC+FastPlanner 框架 - 实物/仿真灵活切换            -->
  <!--  支持：实物平台 (hf_platform) + Gazebo 仿真                -->
  <!-- ========================================================= -->

  <!-- ========== 运行环境参数 ========== -->
  <!-- mode: 'real' (实物) | 'sim' (仿真) -->
  <arg name="mode" default="sim"/>
  <arg name="debug" default="false"/>

  <!-- 根据 mode 设置时钟 -->
  <param name="/use_sim_time" value="true" if="$(eval mode == 'sim')"/>
  <param name="/use_sim_time" value="false" if="$(eval mode == 'real')"/>

  <!-- ========== 话题配置 (根据 mode 自动适配) ========== -->

  <!-- 里程计话题 -->
  <arg name="odom_topic" default="/odom"/>

  <!-- 激光雷达/点云话题 -->
  <!-- 实物: /scan_full_filtered (LaserScan) -->
  <!-- 仿真: /front/scan (LaserScan) -->
  <arg name="scan_topic" if="$(eval mode == 'real')" default="/scan_full_filtered"/>
  <arg name="scan_topic" if="$(eval mode == 'sim')" default="/front/scan"/>

  <!-- 点云话题 (转换后的) -->
  <arg name="cloud_topic" default="/point_cloud_map"/>

  <!-- 速度命令话题 -->
  <!-- 实物: /mpc/cmd_vel_raw (经过安全开关) -->
  <!-- 仿真: /cmd_vel (直接) -->
  <arg name="cmd_vel_topic" if="$(eval mode == 'real')" default="/mpc/cmd_vel_raw"/>
  <arg name="cmd_vel_topic" if="$(eval mode == 'sim')" default="/cmd_vel"/>

  <!-- 地图参数 -->
  <arg name="map_size_x" default="40.0"/>
  <arg name="map_size_y" default="40.0"/>
  <arg name="map_size_z" default="0.5"/>

  <!-- 速度限制 -->
  <arg name="max_vel" if="$(eval debug)" default="0.3"/>
  <arg name="max_vel" if="$(eval not debug)" default="0.6"/>
  <arg name="max_acc" if="$(eval debug)" default="0.3"/>
  <arg name="max_acc" if="$(eval not debug)" default="0.5"/>


  <!-- ========== 1. 点云转换节点 ========== -->
  <!-- 功能：将激光扫描转换为点云 (odom frame) -->
  <node pkg="lidar2world" name="lidar2world_node" type="lidar2world_node"
        output="screen" launch-prefix="bash -c 'sleep 3; $0 $@' ">
    <!-- 处理 LaserScan → PointCloud2 -->
    <param name="input_scan_topic" value="$(arg scan_topic)"/>
    <param name="output_cloud_topic" value="$(arg cloud_topic)"/>
    <param name="target_frame" value="odom"/>
  </node>


  <!-- ========== 2. FastPlanner 规划器 ========== -->
  <include file="$(find plan_manage)/launch/lidar.xml">
    <!-- 地图参数 -->
    <arg name="map_size_x_" value="$(arg map_size_x)"/>
    <arg name="map_size_y_" value="$(arg map_size_y)"/>
    <arg name="map_size_z_" value="$(arg map_size_z)"/>

    <!-- 话题参数 -->
    <arg name="odometry_topic" value="$(arg odom_topic)"/>
    <arg name="camera_pose_topic" value="/camera/pose"/>
    <arg name="depth_topic" value="/depth"/>
    <arg name="cloud_topic" value="$(arg cloud_topic)"/>

    <!-- 相机参数（LiDAR模式不使用，占位符） -->
    <arg name="cx" value="320.5"/>
    <arg name="cy" value="240.5"/>
    <arg name="fx" value="554.25"/>
    <arg name="fy" value="554.25"/>

    <!-- 速度约束 -->
    <arg name="max_vel" value="$(arg max_vel)"/>
    <arg name="max_acc" value="$(arg max_acc)"/>

    <!-- 航点参数 (RViz 2D Nav Goal) -->
    <arg name="point_num" value="1"/>
    <arg name="point0_x" value="0.0"/>
    <arg name="point0_y" value="0.0"/>
    <arg name="point0_z" value="0.0"/>
    <arg name="point1_x" value="0.0"/>
    <arg name="point1_y" value="0.0"/>
    <arg name="point1_z" value="0.0"/>
    <arg name="point2_x" value="0.0"/>
    <arg name="point2_y" value="0.0"/>
    <arg name="point2_z" value="0.0"/>
    <arg name="flight_type" value="1"/>
  </include>


  <!-- ========== 3. 轨迹服务器 (仅在有需要时启用) ========== -->
  <!-- 可选：如果需要从B样条轨迹生成速度指令，启用此节点 -->
  <arg name="use_traj_server" default="false"/>
  <node if="$(arg use_traj_server)" pkg="plan_manage" name="traj_server"
        type="traj_server" output="screen">
    <remap from="/position_cmd" to="/planning/pos_cmd"/>
    <remap from="/odom_world" to="$(arg odom_topic)"/>
    <param name="traj_server/time_forward" value="1.5" type="double"/>
  </node>


  <!-- ========== 4. 航点生成器 ========== -->
  <node pkg="waypoint_generator" name="waypoint_generator" type="waypoint_generator"
        output="screen">
    <remap from="waypoint_generator/odom" to="$(arg odom_topic)"/>
    <remap from="waypoint_generator/goal" to="/move_base_simple/goal"/>
    <remap from="waypoint_generator/traj_start_trigger" to="/traj_start_trigger"/>
    <param name="waypoint_type" value="manual-lonely-waypoint"/>
  </node>


  <!-- ========== 5. MPC 跟踪控制器 ========== -->
  <node pkg="mpc_tracking" name="mpc_tracking_node" type="mpc_tracking_node"
        output="screen">
    <!-- 话题重映射 -->
    <param name="cmd_vel_topic" value="$(arg cmd_vel_topic)"/>
    <param name="odom_topic" value="$(arg odom_topic)"/>

    <!-- 速度方向校正 (如果方向反了可以调这个) -->
    <param name="reverse_vel_x" value="false" type="bool"/>
    <param name="reverse_vel_y" value="false" type="bool"/>

    <!-- MPC 控制参数 -->
    <param name="dt" value="0.1" type="double"/>
    <param name="N" value="60" type="int"/>
    <param name="max_v_xy" value="$(arg max_vel)" type="double"/>
    <param name="max_a_xy" value="$(arg max_acc)" type="double"/>

    <!-- 代价函数权重 -->
    <param name="w_pos" value="10.0" type="double"/>
    <param name="w_yaw" value="5.0" type="double"/>
    <param name="w_u" value="2.0" type="double"/>
    <param name="w_du" if="$(eval debug)" value="10.0" type="double"/>
    <param name="w_du" if="$(eval not debug)" value="50.0" type="double"/>
  </node>


  <!-- ========== 6. 安全开关节点 (仅在实物模式启用) ========== -->
  <!-- 功能：紧急停止 + 手柄控制切换 (实物平台专用) -->
  <node if="$(eval mode == 'real')" pkg="mpc_tracking" name="safety_switch"
        type="safety_switch_node" output="screen">
    <param name="stop_button" value="2"/>  <!-- B键紧急停止 -->
  </node>


  <!-- ========== 7. RViz 可视化 ========== -->
  <node pkg="rviz" type="rviz" name="rviz"
        args="-d $(find mpc_tracking)/launch/rviz.rviz"
        required="false"/>


  <!-- ========== 启动提示 ========== -->
  <!-- 实物模式提示 -->
  <node if="$(eval mode == 'real')" pkg="rostopic" type="rostopic" name="startup_info"
        args="echo -e '\\n========================================\\n  MPC+FastPlanner - REAL PLATFORM MODE\\n========================================\\n  激光: /scan_full_filtered\\n  速度输出: /mpc/cmd_vel_raw\\n  安全开关: B键紧急停止\\n========================================\\n'"
        output="screen" launch-prefix="bash -c 'sleep 2; '"/>

  <!-- 仿真模式提示 -->
  <node if="$(eval mode == 'sim')" pkg="rostopic" type="rostopic" name="startup_info"
        args="echo -e '\\n========================================\\n  MPC+FastPlanner - SIMULATION MODE\\n========================================\\n  激光: /front/scan\\n  速度输出: /cmd_vel\\n  RViz: 使用 2D Nav Goal 设置目标点\\n========================================\\n'"
        output="screen" launch-prefix="bash -c 'sleep 2; '"/>

  <!-- 调试模式提示 -->
  <node if="$(arg debug)" pkg="rostopic" type="rostopic" name="debug_info"
        args="echo -e '\\n⚠️  DEBUG MODE: 速度限制 = $(arg max_vel) m/s\\n'"
        output="screen" launch-prefix="bash -c 'sleep 2; '"/>

</launch>
